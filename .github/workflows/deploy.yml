name: Deploy to Hoststar (SSH/rsync)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Falls du einen Build hast, hier wieder aktivieren:
      # - name: Install dependencies
      #   run: npm ci
      #
      # - name: Build
      #   run: npm run build
      #
      # Und dann unten bei rsync statt "./" z.B. "dist/" verwenden.

      - name: Prepare SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Einfacher SSH-Config-Eintrag f√ºr den Host
          cat <<EOF >> ~/.ssh/config
          Host deploy-host
            HostName ${{ secrets.SSH_HOST }}
            User ${{ secrets.SSH_USER }}
            Port ${{ secrets.SSH_PORT }}
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
          EOF

      - name: Debug SSH connection
        run: |
          echo "Testing SSH connection..."
          ssh deploy-host "echo 'SSH OK on $(hostname)'"
          echo "---- End of SSH test ----"

      - name: Deploy via rsync over SSH
        run: |
          # Quelle: aktuelles Repo (./)
          # Ziel: dein Webroot auf dem Server
          # Wenn du ein Build-Dir hast, nimm statt "./" z.B. "dist/"
          rsync -avz --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'node_modules/' \
            ./ \
            deploy-host:${{ secrets.SSH_REMOTE_DIR }}
